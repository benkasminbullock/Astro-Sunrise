-*- encoding: utf-8; indent-tabs-mode:nil -*-

=encoding utf-8

=head1 Document Status

This text is published under the I<Creative Commons> license
CC-BY-ND.

Copyright (c) 2017 Jean Forget. All rights reserved.

The text is often (but irregularly) updated on Github. There are
a French version and an English version. Since I am more at ease
discussing astronomical subjects in French, the English version
will lag behind the French one.

This text is an integral part of the module's distribution package.
So you can read it on web pages generated from CPAN
(L<http://search.cpan.org>, L<https://metacpan.org>, etc).
But it is not used during the module installation process.
So, I guess it will not appear in C<.deb> or C<.rpm> packages.

=head1 Why This Text? For Whom?

The main purpose of this text is to explain how the sunrises
and sunsets are computed. These explanations are much too long
to be included into the module's POD section.

=head2 For Whom? For Me

You may be surprised that the main person for whom I write this
is myself. I write this text to remember which problems I have
encountered while maintaining this module and how I fixed them.
But mainly, I write this to build a detailed description of the
precise iterative algorithm, because 
L<Paul Schlyter's explanations|http://www.stjarnhimlen.se/comp/riset.html#3>
are not detailed enough for my taste and there is no
compilable source available to check this algorithm (unlike the 
L<simple version without iteration|http://www.stjarnhimlen.se/comp/sunriset.c>).

Have you read
L<brian's Guide to Solving Any Perl Problem|http://www252.pair.com/~comdog/brian's_guide.pod>?
One of the advices consists in "talking to the teddy-bear".
I prefer writing (on GitHub) for my teddy-bear.

=head2 For Whom? For The Next Module Maintainer

The second person for whom I write is the next module maintainer. I have read
L<Neil Bowers' message|http://codeverge.com/perl.module-authors/the-module-authors-pledge/744969>
about I<the module authors pledge>. I agree with him and I declare that
should I stop maintaing my modules for whatever reason, I accept that 
any volunteer can take charge of them.

What Neil did not explain, is that the new maintainer must obey a few
criteria and must have three available resources to take over a module maintenance:
be competent in Perl programming, have enough available time to work on
the module and be enthusiastic enough to get around to it.

In the case of astronomical module, the competence in Perl programming is
not enough, you must also be competent in astronomy. So, if you think you might
maintain this module, first read the present text. If you understand why I bother
about such and such question, if you can follow my train of thought without being
lost, then you are competent enough. If you think I am playing
L<Captain Obvious|http://tvtropes.org/pmwiki/pmwiki.php/Main/CaptainObvious>
and if you have instant answers to my questions, then you are the ideal
person which could maintain this module. If you do not understand what all
this is about, and if sines and cosines put you off, do not consider
working on this module's innards.

=head2 For Whom? For Bug Reporters

This text is also for those who think they have found a bug
in the module or who want to offer an idea to improve the module.
Maybe the bug is already known and is waiting for a fix.
Maybe the bug was found and the fix is not successful. Maybe
the proposed improvement contradicts some other functionality
of the module.

=head2 For Whom? For Curious Users

Lastly, this text is aimed at any person curious enough to learn
a few astronomical facts. I tried to steer away from overly complicated
computations. Their place is in the Perl source, not in this text.
Yet, you will find here simple computations and mathematical reasoning.

=head2 Remarks About The Style

Some chunks of this text appear as a series of questions and answers.
This is not a FAQ. Rather, this is a elegant way to give a progressive
explanation of some subject. This method has already been used by 
many other writers, especially Plato, Galileo and Douglas Hofstadter.

=head2 Other Remarks

In my explanations, I usually take the point of view of a person living
in the Northern hemisphere, between the Tropic of Cancer and the Arctic Circle.
For example, I will write that at noon, the sun is located exactly southward,
although any schoolboy from Australia, New Zealand, South Africa, Argentina
and similar countries perfectly know that at noon, the sun is northward.

In a similar way, 21st of March is called the I<vernal equinox> or the
I<spring equinox>, even if it pinpoints the beginning of autumn in the Southern
hemisphere.

But using politically correct sentences would yield convoluted phrases, 
which hinders the pedagogical purpose of the text and the understanding
of the described phenomena.

=head1 Sources

I will give here only the sources that provide lists of numerical values.
Books and articles with only a literary description of the subject are too
many to be listed here.

=head2 Unused Sources

Some sources provide a list of sunsets and sunrises, but I did not use
them because they do not explain which algorithm they use or because
I cannot control the parameters.

=over 4

=item The I<Almanach Du Facteur>

In France, it is (or rather it was) customary to buy almanachs from the postman
each year. In each almanach, you find a page giving the sunrise and sunset times
for all the days of the year. Unfortunately, the times are given in HH:MM syntax, not
including the seconds. In addition, even if you buy a provincial edition, the
sunrise and sunset times are given for Paris. Lastly, the algorithm is not
specified.

=item The I<Institut de Mécanique Céleste et de Calcul des Éphémérides> (IMCCE, Institute of Celestial Mechanics and Ephemerides Computation)

This L<website|https://www.imcce.fr/langues/fr/index.html>
(also available in L<english|https://www.imcce.fr/langues/en/index.html>)
used to give an HTML form to generate a table giving the sunrise and sunset times
for a location and a time span  of your choosing. Unfortunately, this webpage
disappeared.

There is an available
L<webservice|http://vo.imcce.fr/webservices/miriade/?rts>
to give the same functionality, but I did not try it.

=back

=head2 Used Sources

=over 4

=item Paul Schlyter's Website

This L<site|http://www.stjarnhimlen.se/english.html>
provides a
L<C program|http://stjarnhimlen.se/comp/sunriset.c> 
ready to compile and use, giving the 
L<sunrise and sunset|http://stjarnhimlen.se/comp/riset.html> 
times. This is the basis of the simple algorithm used in
C<Astro::Sunrise>. Its precision, as stated by the author,
is one or two minutes, but it can be much less precise depending
on the location and date, especially when we are close to the
beginning or the end of the period when the midnight sun is visible.

Paul Schlyter's website includes also
L<many informations|http://stjarnhimlen.se/comp/ppcomp.html> 
about computing the position of various celestial bodies.
This website is very interesting, but I preferred writing
my own version, describing the computation of only the sun
and not bothering with other celestial bodies.

=item The U.S Naval Observatory

L<The US Naval Observatory|http://aa.usno.navy.mil/faq/index.php> 
gives a
L<HTML form|http://aa.usno.navy.mil/data/docs/RS_OneYear.php>
to compute the sunrise and sunset times. These times are given
in HH:MM format. I would have preferred HH:MM:SS, but I will have
to deal with just HH:MM.

This website gives also 
L<very interesting informations|http://aa.usno.navy.mil/faq/index.php>
about celestial computations, but without restricting itself to the sun,
like I am doing here.

=item Stellarium

Stellarium is a PC app to simulate a night sky. If you do not bother with
the main view giving a real time sky simulation, you can use it to obtain
the coordinates of a given celestial body at a given time when seen from
a given Earth location.

TO BE COMPLETED

=back

=head1 Heliocentrism Or Geocentrism?

Here are two assertions. Are they true of false?

=over 4

=item A

The Sun goes around the Earth.

=item B

The Earth goes around the Sun.

=back

Assertion A is false, everyone agrees. But assertion B is false too.

Oh yes indeed, will you answer, it should read actually:

=over 4

=item C

The Earth runs along an elliptic orbit with the Sun located on
one focus of the ellipse.

=back

This assertion is false too. Each one of the following assertions
is nearer to the truth than assertions B and C (and A).

=over 4

=item D

The center of mass of the Earth-Moon binary system runs along an
elliptic orbit with the center of mass of the Solar System located
on a focus of the ellipse.

And I will point that the center of mass of the Sun is not the same
as the center of mass of the Solar System. There are even times when
the center of mass of the Solar System is I<outside> the surface of the Sun.
The L<webpage|http://hp41programs.yolasite.com/solar-sys-bary.php>
about an HP-41 program states that on 15th March 1983, the distance between
both centers of mass was nearly 2.1 Sun radii.

=item E

The Earth runs along an orbit around the Sun, with noticeable perturbations
caused by the Moon, Jupiter, Saturn, etc.

Which is a formulation equivalent to assertion D.

=item F

The movement of the Earth with the Solar System is a I<n>-body problem,
with I<n> ≥ 3. Therefore, there is no analytical solution.

=item G

The Solar System is a chaotic system. Even if we can predict with a reasonable
accuracy what the various orbits will look like within the next hundred million
years, this prediction is no longer possible for an interval of one milliard years
(one billion years for US).

=item H

The Earth corkscrews in the general direction of the Hercules constellation
with a approximate speed of 220 km/s.

=item I

The Earth runs along an orbit around the center of the Milky Way, with noticeable
perturbations caused by the Sun, the Moon, Jupiter, Saturn, etc.

=back

Assertions B and C are what Terry Pratchett, Jack Cohen and Ian Stewart call
I<lies to children> (I<Science of Discworld>, chapter 4, pages 38 and 39). These
are false assertions, but simple enough to be understood by a child and which, even
if false, leads children to a better understanding of the described phenomena and brings
them closer to truth. You cannot tell assertion C to a child and expect him to understand
it without telling him first assertion B. And it is worse with assertions D and next.

Moreover, these are I<lies to adults>. In the beginning, people would consider that
the aim of Physics was to build a mathematical representation of the real world,
getting closer and closer to the ultimate truth. Then, there was quantum physics
including especially de Broglie's work
with the duality of wave and particle and the Copenhagen interpretation. Is the ultimate
nature of the electron (for example) a wave? No. Is it a particle? No. So what? We do not
care about the ultimate nature of the electron. The aim of Physics is to no longer
to provide a mathematical I<representation> of the real world, but to build 
several mathematical I<models> of the real world. We know that intrinsically all
models are false, but each one has it usefulness to lead to make computations about
the real world.

Please note that I was talking about scientific methods. I was not dealing with 
electoral campaigns and advertisements. Every sane adult knows for
sure that these are ridden with lies.

Other lies to adults you will find in the following:

=over 4

=item *

the light propagates instantly from one place to another,

=item *

the celestial bodies outside the Solar System are motionless,

=item *

they are located on a sphere call the I<Celestial Sphere>, 

=item *

UTC time is equal to GMT time

=item *

the Earth's surface is a perfect sphere, without any mountains, valleys or molehills,

=item *

and, as I have already stated, all interesting locations
on Earth are between the Tropic of Cancer and the Arctic Circle.

=back

In some paragraphs, I will temporarily set aside some of these lies. But in most
paragraphs all these lies will be in effect.

=head2 Conclusion

All this to explain that in the following text, I will not refrain from using
the geocentric model where the Sun turns around the Earth in 24 hours or the 
geocentric model where the Sun turns arount the Earth in 365.25 days.

"It is not necessary that the following hypothesis be true or even
resemble the truth. One thing is for sure that they provide calculations
in accordance with the actual observations"

Excerpt from Osiander's preface to Copernic's book. This excerpt was reused
by Jean-Pierre Petit as a foreword to
L<Cosmic Story|http://www.savoir-sans-frontieres.com/JPP/telechargeables/English/cosmic_story_anglo_indien/cosmic_story_en.html>.
In Copernic's time, Osiander wanted to have heliocentrism accepted
by people who were certain that geocentrism was the one and only truth.
It is ironical that I use the same quotation to have geocentrism accepted
by people who believe that heliocentrism is the one and only truth.

=head1 Earth / Sun Movements

=head2 Basic Movements

In an heliocentric system pointing at fixed stars, Earth orbits around the
Sun in one year. In other words, in a geocentric system, the Sun orbits around
the Earth in one year, with an average speed of 0.986 degrees per day.

Also, the Earth spins around itself, making one turn in 23h 56mn 4s,
with a speed of 4.178e-3 degrees per second, that is, 360.986 degrees per day.

Q: I thought that the Earth was spinning in 24h!

A: While the Earth spins, the Sun orbits around it. And what we see is
the combination of both movements, which gives a combined speed of 360 degrees per day.
What the commoner is interesting in is to find the Sun at the same place in the
sky at regular times day after day.  Only after this is achieved, the commoner
becomes a learned person and is interested in knowing the position of the Moon,
the stars and the planets.

Q: And why did you say "average" two or three times?

A: Because the angular speed of the Sun is not constant.  We will get back
to this question later.

=head2 Coordinates

The ecliptic is the plane where the Earth's orbit around the Sun is located (when
using an heliocentric model) or where the Sun's orbit around the Earch is 
located (when using a geocentric model). We define also the equatorial plane,
the plane which contains the Earth's equator. These two planes intersect with
a 23° 26' angle. The intersection is a line, named I<line of nodes>.
In some cases, it is more convenient to use a half-line than a line.
In this case, the line of nodes is a half line starting at the Earth center
and aiming at the Pisces constellation.
The point where the line of nodes meets the celestial sphere is called
I<vernal point> (which is politically incorrect, this is the beginning of
autumn in the southern hemisphere).

For a point on Earth, we generally use longitude and latitude. We start from
an origin in the Gulf of Guinea, where the Greenwich meridian meets the equator.
Then  we move along the equator in a first arc and along a meridian in a second arc
to reach the point. The angle of the first arc is the longitude, the angle of the
second arc is the latitude for a point on the ground. But when we consider a celestial body, the
first angle is counted from the line of nodes instead of the Gulf
of Guinea and is named I<right ascension>; the second angle is names I<declination>.
The right ascension is usually expressed as hours, minutes and seconds instead of
degrees. The declination still uses degrees.

I<Ecliptic coordinates> follow the same principle, but the first arc is drawn
along the ecliptic instead of the equator. Likewise, the second arc is perpendicular
to the ecliptic. These angles are named I<ecliptic longitude> and I<ecliptic latitude>
respectively. The ecliptic longitude is counted from the same origine as the
right ascension: the line of nodes. That simplifies a little bit the conversions
between the two systems of coordinates. On the other hand, the use of hours, minutes
and seconds for the right ascension and of degrees for all other angles
is an unnecessary complication in the conversions.

Because of the definition of the ecliptic plane, the ecliptic latitude of the
sun is always zero.

Lastly, there is the local coordinate system. For a given celestial body, we
project its location to the ground, or rather to the plane that is tangent to
the ground. The angle between the North and this location on the tangent plane
is called I<azimuth> and the angle between the tangent plane and the line to the 
celestial body is name I<altitude>.

=head2 Other Movements

Before I explain the other movements involved with the
Sun and the Earth, let me tell you a little digressive note.

=head3 Weather And Climate

I hate these people who, each time snow falls, cry
"Where is this global warming scientists talk about
again and again?" These people seem to ignore that
climate and weather are two different things. When
the temperature from a meteorologic station varies
by 10 degrees C from one day to the following, this
is a mundane meteorological event. When the I<average>
temperature for a decade varies by 2 degrees C from
one century to the next, this is a catastrophic
climate event.

The movements I explain below are more "climatic" and
less "meteorogical" than Earth's spin and orbital
rotation. Their values over a short timespan are so
low that the algorithms computing astronomical positions
over a short timespan do not care about them.

Note: weather (but not climate) will come back in a few
chapters, but as a real phenomenon, not as a metaphor.

=head3 Equinox Precession

The best known movement with a long timescale is the
equinox precession. Presently, the vernal point lies
within the constellation of Pisces. But actually, it moves
all along the ecliptic, making a whole turn in about
26,000 years.

=head3 Nutation

The angle between the equatorial plane and the ecliptic
plane varies slightly. I did not find the characteristics of this
movement.

=head3 Perihelion Precession

There is also the perihelion precession. This movement
is best known for Mercury, because it is the most apparent,
but all other planets have a perihelion precession, including
the Earth.

=head3 Other Drifts And Fluctuations

The formulas computing the positions of celestial bodies
use some constants. But these values are constant only
on a short timespan (astronomically speaking; or, with the
metaphor above, on a meteorological timespan). For example,
everybody knows that the day lasts 24 hours (the mean
solar day, not the sidereal day). Yet, as I have read it
somewhere, in paleontological times, it used to last
22 hours or so.

The variation of the duration of the day is a tiny
variation, but with our modern measure isntruments, we
can measure it. Since the scientists abolished the
astronomical standard of time for an atomic
standard, it has been necessary to add 27 leap seconds
over 47 years to synchronise the atomic timescale with
the Earth's spin.

For the moment, all adjustments have consisted in
adding a leap second. But it can happen that we
would have to synchronise in the other direction by removing
a second. So this phenomenon produces fluctuations
rather than a slow drift in a single direction.

=head3 The Equation Of Time

There are other fluctuations, easier to measure and with a more
"meteorological" and less "climatic" timescale. The I<true> solar noon
does not occur on the same precise time as the I<mean> solar noon.
There are two reasons.

=head4 Obliquity of the Earth

First, there is an angle between the ecliptical plane and the equatorial plane,
therefore, a constant-speed rotation on the ecliptical plane does not translate
to a constant-speed rotation when measured by right ascension on the equatorial 
plane. The rate of variation of the right ascension is a variable rate.

If we use the same units for the ecliptic longitude and the right ascension
(either degrees or hours), then both values are nearly equal, but still different.
So, when the ecliptic longitude is 46°20'31", the right ascension is 43°52'36",
that is, a 2°27'54" gap. The same happens at longitude 226°20'31". And at
longitude 313°32'52", the right ascension is 316°47", that is a gap of 2°27'54",
but in the other direction. And the same happens at 133°32'52". These are
the maximum values for the gap when using an obliquity of 23°26'.
And if you prefer hours, here are the values:

  .   longitude   right ascension      gap     longitude   right ascension   gap
  .   3h05mn22s      2h55mn30s       -9mn51s   46°20'31"     43°52'36"      2°27'54"
  .   8h54mn11s      9h04mn03s        9mn51s  133°32'52"    136°00'47"     -2°27'54"
  .  15h05mn22s     14h55mn30s       -9mn51s  226°20'31"    223°52'36"      2°27'54"
  .  20h54mn11s     21h04mn03s        9mn51s  313°32'52"    316°00'47"     -2°27'54"

=head4 Kepler's Second Law

Second, the rotational speed of Sun itself on the ecliptical plane is not a constant.
It obeys Kepler's second law, with a rotational speed more or less inversely 
proportional to the Earth-Sun distance.

Q: You cannot apply Kepler's second law to a geocentric model!

A: No. Kepler's second law applies to a barycentric model as D above. It applies
I<approximately> to an heliocentric model as C. But once we have computed
Earth's angular speed on its orbit around the Sun in model C, the computation of the
Sun's coordinates and speed in the geocentric model B is very simple. Especially,
the Sun's angular speed in a geocentric model is equal to the Earth's speed in
an heliocentric model.

Here are the Sun's positions for 2017, as given by Stellarium. The software
gives the equatorial coordinates and I translate them  into ecliptic coordinates.

  date       right asc.   declination  ecliptic longitude
  4 January  18h59mn1s     -22°44'43"   -76°24'58" or -76,4162°
  5 January  19h3mn24s     -22°38'18"   -75°23'58" or -75,3996°
  3 July      6h48mn        22°58'35"   101°2'7"   or 101,0355°
  4 July      6h52mn8s      22°53'39"   101°59'26" or 101,9907°

This translates as a speed of 1.0166 degree per day in January at perigee (when
in a geocentric model, that is perihelion in an heliocentric model) and a speed
of 0.9552 degree per day in July at apogee (or aphelion).

=head4 Equation of Time

The Earth's spin velocity is constant, that is 360.986 degrees per day
but the Sun's orbital speed around the Earth is not. The combination of
both speed is variable and it is I<not> 360 degrees per day. The crossing
of the meridian by the Sun is not exactly every 86400 seconds.
There is a difference between the Solar I<Mean> Time, where noon occurs
every 86400 seconds, no more, no less, and the Solar I<Real> Time, in which
noon is defined by the time when the Sun crosses the meridian. The difference
between the Solar Mean Time and the Solar Real Time is called I<equation
of time>.

Here are the extreme values for the equation of time in 2017, computed
by a script using L<DateTime::Event::Sunrise> and refined with Stellarium.

  Date          DT::E::S    Stellarium
  2017-11-02    11:43:33    11:43:37   -16mn23s  earliest noon value,
  2017-02-10    12:14:12    12:14:14   +14mn14s  latest noon value
  2017-09-11    11:56:33    11:56:34    -3mn26s
  2017-09-12    11:56:11    11:56:13    -3mn47s  biggest decrease: 21 or 22 seconds
  2017-12-17    11:56:11    11:56:14    -3mn46s
  2017-12-18    11:56:41    11:56:44    -3mn16s  biggest increase: 30 seconds

And here is the curve for the equation of time.

=for html
<p>
<img src='equ-time.png' alt='Curve of the equation of time during one year' />
</p>

=head4 The Analemma

The irregularity of the Sun's trajectory can be visualised by using the Local Mean Time
as a reference and pinpointing the positions of the Sun at noon in LMT.
The various Sun positions day after day build an 8-shaped curve, called I<analemma>.

=head4 Mean Sun, Virtual Homocinetic Sun

In the following, it is useful to imagine a virtual Sun which would use an constant
angular speed (either in equatorial coordinates or ecliptic coordinates, depending on
which is more convenient).

The concept of I<Mean Sun> is a virtual Sun like this, calibrated so it crosses
the meridian at 12h00 (Local Mean Time) each day, and which minimizes the difference
between the real local noon and the mean local noon. 

I will also consider several "virtual homocinetic suns" or VHS (no relation with
magnetic tapes). These virtal suns are synchronised with the real Sun at some 
convenient point and then move with a constant angular speed.
